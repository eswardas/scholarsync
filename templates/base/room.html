<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ room.name }} - ScholarSync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css?v=6">

    <style>
        .navbar {
            /* This z-index ensures the navbar and its dropdown appear on top of other page content */
            z-index: 1050;
        }
    </style>
    </head>
<body class="bg-dark">
    <nav class="navbar navbar-expand-lg navbar-dark bg-black border-bottom border-secondary">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="{% url 'home' %}">ScholarSync</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link text-light" href="{% url 'topics' %}">Topics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-light" href="{% url 'activity' %}">Activity</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    {% if request.user.is_authenticated %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userMenu" data-bs-toggle="dropdown">
                                <span class="me-2 user-avatar rounded-circle bg-primary d-inline-grid place-items-center text-white" style="width:28px;height:28px;display:inline-grid;place-items:center;">
                                    {{ request.user.username|first|upper }}
                                </span>
                                <span class="fw-600">{{ request.user.username }}</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
                                <li><a class="dropdown-item" href="{% url 'user-profile' request.user.id %}">Profile</a></li>
                                <li><a class="dropdown-item" href="{% url 'update-user' %}">Update Profile</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="{% url 'logout' %}">Logout</a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item"><a class="nav-link text-light" href="{% url 'login' %}">Login</a></li>
                        <li class="nav-item"><a class="nav-link text-light" href="{% url 'register' %}">Register</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="text-white mb-0">{{ room.name }}</h2>
                        <small class="text-muted">{{ room.get_study_type_display }} ‚Ä¢ {{ room.topic.name }}</small>
                        {% if room.is_private %}
                            <span class="badge bg-warning text-dark ms-2">PRIVATE</span>
                        {% endif %}
                    </div>
                    {% if request.user == room.host %}
                        <div class="btn-group">
                            <a href="{% url 'update-room' room.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                            <a href="{% url 'delete-room' room.id %}" class="btn btn-sm btn-outline-danger">Delete</a>
                        </div>
                    {% endif %}
                </div>

                <div class="card bg-dark border-secondary mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="text-light mb-2"><strong>Host:</strong> {{ room.host.username }}</p>
                                <p class="text-light mb-0"><strong>Participants:</strong> <span id="participant-count">{{ room.participant_count }}</span> / {{ room.max_participants }}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="text-light mb-2"><strong>Created:</strong> {{ room.created|timesince }} ago</p>
                                <p class="text-light mb-0"><strong>Last Active:</strong> {{ room.updated|timesince }} ago</p>
                            </div>
                        </div>
                        {% if room.description %}
                            <hr class="border-secondary">
                            <p class="text-light mb-0"><strong>Description:</strong> {{ room.description }}</p>
                        {% endif %}
                        {% if room.is_private %}
                            <hr class="border-secondary">
                            <p class="text-light mb-0"><strong>Room ID:</strong> {{ room.private_id }}</p>
                            <p class="text-light mb-0"><strong>Password:</strong> {{ room.private_password }}</p>
                        {% endif %}
                    </div>
                </div>

                <div class="card bg-dark border-secondary mb-4">
                    <div class="card-header bg-black border-secondary">
                        <h5 class="text-white mb-0">Discussion</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="p-3" id="chat-messages" style="max-height: 500px; overflow-y: auto;">
                            {% for message in room_messages %}
                                <div class="message bg-black border border-secondary rounded p-3 mb-3"
                                     id="message-{{ message.id }}"
                                     data-message-id="{{ message.id }}"
                                     data-user-id="{{ message.user.id }}">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="d-flex align-items-center">
                                            <strong>
                                                <a href="{% url 'user-profile' message.user.id %}" class="text-primary text-decoration-none">
                                                    {{ message.user.username }}
                                                </a>
                                            </strong>
                                            <small class="text-muted ms-2">{{ message.created|timesince }} ago</small>
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            {% if request.user.is_authenticated %}
                                                <button class="btn btn-outline-secondary reply-btn"
                                                        data-message-id="{{ message.id }}"
                                                        data-username="{{ message.user.username }}">Reply</button>
                                                <button class="btn btn-outline-warning report-btn"
                                                        data-message-id="{{ message.id }}"
                                                        data-username="{{ message.user.username }}">Report</button>
                                            {% endif %}
                                            {% if request.user == message.user or request.user.is_superuser %}
                                                <button class="btn btn-outline-danger delete-btn" data-message-id="{{ message.id }}">
                                                    {% if request.user.is_superuser and request.user != message.user %}Delete (Admin){% else %}Delete{% endif %}
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>

                                    {% if message.parent %}
                                        <div class="small text-muted mb-2">
                                            Replying to
                                            <a href="{% url 'user-profile' message.parent.user.id %}" class="text-primary text-decoration-none">
                                                @{{ message.parent.user.username }}
                                            </a>:
                                            ‚Äú{{ message.parent.body|truncatechars:80 }}‚Äù
                                        </div>
                                    {% endif %}

                                    <p class="text-light mb-2 message-body">{{ message.body }}</p>

                                    {% if message.file_attachment %}
                                        <div class="mb-2">
                                            {% if message.file_type == 'image' %}
                                                <img src="{{ message.file_attachment.url }}" class="img-fluid rounded" style="max-height: 300px;">
                                            {% elif message.file_type == 'audio' %}
                                                <audio controls class="w-100">
                                                    <source src="{{ message.file_attachment.url }}" type="audio/mpeg">
                                                    Your browser does not support the audio element.
                                                </audio>
                                            {% elif message.file_type == 'video' %}
                                                <video controls class="w-100" style="max-height: 300px;">
                                                    <source src="{{ message.file_attachment.url }}" type="video/mp4">
                                                    Your browser does not support the video element.
                                                </video>
                                            {% else %}
                                                <a href="{{ message.file_attachment.url }}" class="btn btn-outline-primary" download>
                                                    üìÑ Download {{ message.file_name }}
                                                </a>
                                            {% endif %}
                                        </div>
                                    {% endif %}

                                    <div class="d-flex gap-2">
                                        <button
                                            class="btn btn-sm {% if message.user_vote and message.user_vote.vote_type == 'like' %}btn-primary{% else %}btn-outline-primary{% endif %} like-btn"
                                            data-message-id="{{ message.id }}">
                                            üëç <span class="like-count">{{ message.votes.filter.vote_type.like.count }}</span>
                                        </button>
                                        <button
                                            class="btn btn-sm {% if message.user_vote and message.user_vote.vote_type == 'dislike' %}btn-danger{% else %}btn-outline-danger{% endif %} dislike-btn"
                                            data-message-id="{{ message.id }}">
                                            üëé <span class="dislike-count">{{ message.votes.filter.vote_type.dislike.count }}</span>
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                {% if request.user.is_authenticated %}
                    <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
                    <div id="reply-context" class="alert alert-info bg-dark border-info text-info d-none py-2 px-3 small mb-2">
                        Replying to <a id="reply-user-link" href="#" class="text-primary">@user</a>:
                        <span id="reply-snippet" class="text-muted"></span>
                        <button type="button" id="cancel-reply" class="btn btn-sm btn-outline-secondary ms-2">Cancel</button>
                    </div>

                    <div class="card bg-dark border-secondary">
                        <div class="card-body">
                            <form id="message-form" method="POST" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" name="parent_id" id="parent_id" value="">
                                <div class="mb-3">
                                    <textarea name="body" id="chat-message-input" class="form-control bg-black text-light border-secondary" placeholder="Share your thoughts..." rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="file_attachment" class="form-label text-light">Attach File (PDF, Image, Video, Audio)</label>
                                    <input type="file" class="form-control bg-dark text-light border-secondary" id="file_attachment" name="file_attachment">
                                </div>
                                <button type="submit" id="chat-message-submit" class="btn btn-primary w-100">Send Message</button>
                            </form>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-warning bg-dark border-warning text-warning">
                        <p class="mb-0">Please <a href="{% url 'login' %}" class="text-primary">login</a> to participate in discussions.</p>
                    </div>
                {% endif %}
            </div>

            <div class="col-md-4">
                <div class="card bg-dark border-secondary">
                    <div class="card-header bg-black border-secondary">
                        <h5 class="text-white mb-0">Participants (<span id="participants-count-display">{{ participants.count }}</span>)</h5>
                    </div>
                    <div class="list-group list-group-flush" id="participants-list">
                        {% for participant in participants %}
                            <a href="{% url 'user-profile' participant.id %}" class="list-group-item list-group-item-action bg-dark text-light border-secondary d-flex justify-content-between align-items-center">
                                {{ participant.username }}
                                {% if participant.is_superuser %}
                                    <span class="badge bg-danger">ADMIN</span>
                                {% endif %}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this message?</p>
                    <p class="text-muted small">This action cannot be undone.</p>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Message</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="reportModalLabel">Report Message</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Reporting message by <strong id="reportUser">@user</strong></p>
                    <div class="mb-3">
                        <label class="form-label">Reason</label>
                        <select id="reportReason" class="form-control bg-black text-light border-secondary">
                            <option value="spam">Spam</option>
                            <option value="abuse">Harassment/Abuse</option>
                            <option value="inappropriate">Inappropriate Content</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Details (optional)</label>
                        <textarea id="reportDetails" class="form-control bg-black text-light border-secondary" rows="3" placeholder="Add any details..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-warning" id="confirmReportBtn">Submit Report</button>
                </div>
            </div>
        </div>
    </div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // CSRF helpers
    function getCookie(name) {
        const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        return match ? decodeURIComponent(match[2]) : null;
    }
    function getCSRFToken() {
        const fromForm = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (fromForm && fromForm.value) return fromForm.value;
        return getCookie('csrftoken');
    }

    // Attach CSRF to all jQuery AJAX requests
    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader('X-CSRFToken', getCSRFToken());
            }
        }
    });

    // Main application logic
    $(function () {
        const roomId = "{{ room.id }}";
        const csrfToken = $('#csrf-token').val();
        const IS_AUTH = {{ request.user.is_authenticated|yesno:"true,false" }};
        let currentMessageId = null;
        let lastMessageId = 0;
        let reportMessageId = null;

        const deleteModalEl = document.getElementById('deleteModal');
        const deleteModal = bootstrap.Modal.getOrCreateInstance(deleteModalEl, { backdrop: true, keyboard: true });

        const reportModalEl = document.getElementById('reportModal');
        const reportModal = bootstrap.Modal.getOrCreateInstance(reportModalEl, { backdrop: true, keyboard: true });

        function safeHideModal(modal, el) {
            try { modal.hide(); } catch(e) {}
            setTimeout(function () {
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open').css('padding-right', '');
                $(el).attr('style', '');
            }, 120);
        }

        deleteModalEl.addEventListener('hidden.bs.modal', function () {
            currentMessageId = null;
            $('#confirmDeleteBtn').prop('disabled', false).text('Delete Message');
        });

        reportModalEl.addEventListener('hidden.bs.modal', function () {
            reportMessageId = null;
            $('#confirmReportBtn').prop('disabled', false).text('Submit Report');
            $('#reportReason').val('spam');
            $('#reportDetails').val('');
        });

        // Compute last message id on load
        const $messages = $('.message');
        if ($messages.length > 0) {
            lastMessageId = Math.max(...$messages.map(function () {
                return parseInt($(this).data('message-id'));
            }).get());
        }

        // Reply handler
        $(document).on('click', '.reply-btn', function () {
            if (!IS_AUTH) return window.location.href = '/login/';

            const msgId = $(this).data('message-id');
            const username = $(this).data('username');
            const userId = $(`#message-${msgId}`).data('user-id') || '';
            const bodyText = ($(`#message-${msgId} .message-body`).text() || '').trim().slice(0, 120);

            $('#parent_id').val(msgId);
            $('#reply-user-link').text(`@${username}`).attr('href', userId ? `/profile/${userId}/` : '#');
            $('#reply-snippet').text(`‚Äú${bodyText}${bodyText.length >= 120 ? '‚Ä¶' : ''}‚Äù`);
            $('#reply-context').removeClass('d-none');

            const $input = $('#chat-message-input');
            if (!$input.val().startsWith(`@${username} `)) {
                $input.val(`@${username} ` + $input.val());
            }
            $input.focus();

            $('html, body').animate({ scrollTop: $('#message-form').offset().top - 100 }, 200);
        });

        // Cancel reply
        $('#cancel-reply').on('click', function () {
            const $input = $('#chat-message-input');
            const mention = $('#reply-user-link').text() + ' ';
            if ($input.val().startsWith(mention)) {
                $input.val($input.val().replace(mention, ''));
            }
            $('#parent_id').val('');
            $('#reply-context').addClass('d-none');
        });

        // Open confirm delete
        $(document).on('click', '.delete-btn', function () {
            currentMessageId = $(this).data('message-id');
            deleteModal.show();
        });

        // Report flow
        $(document).on('click', '.report-btn', function () {
            if (!IS_AUTH) return window.location.href = '/login/';
            reportMessageId = $(this).data('message-id');
            const user = $(this).data('username');
            $('#reportUser').text('@' + user);
            reportModal.show();
        });

        $('#confirmReportBtn').on('click', function () {
            if (!reportMessageId) return;
            const $btn = $(this).prop('disabled', true).text('Submitting...');
            $.ajax({
                url: `/report/${reportMessageId}/`,
                type: 'POST',
                data: {
                    reason: $('#reportReason').val(),
                    details: $('#reportDetails').val()
                },
                success: function () {
                    alert('Report submitted. Thank you!');
                    safeHideModal(reportModal, reportModalEl);
                    $btn.prop('disabled', false).text('Submit Report');
                },
                error: function () {
                    alert('Error submitting report');
                    safeHideModal(reportModal, reportModalEl);
                    $btn.prop('disabled', false).text('Submit Report');
                }
            });
        });

        // Poll new messages/participants
        setInterval(function () {
            $.ajax({
                url: `/room/${roomId}/data/`,
                type: 'GET',
                data: { last_id: lastMessageId },
                success: function (response) {
                    if (response.messages && response.messages.length > 0) {
                        response.messages.forEach(function (msg) {
                            if ($(`#message-${msg.id}`).length === 0) {
                                let fileHtml = '';
                                if (msg.file_attachment) {
                                    if (msg.file_type === 'image') {
                                        fileHtml = `<div class="mb-2"><img src="${msg.file_attachment}" class="img-fluid rounded" style="max-height:300px;"></div>`;
                                    } else if (msg.file_type === 'audio') {
                                        fileHtml = `<div class="mb-2"><audio controls class="w-100"><source src="${msg.file_attachment}" type="audio/mpeg"></audio></div>`;
                                    } else if (msg.file_type === 'video') {
                                        fileHtml = `<div class="mb-2"><video controls class="w-100" style="max-height:300px;"><source src="${msg.file_attachment}" type="video/mp4"></video></div>`;
                                    } else {
                                        fileHtml = `<div class="mb-2"><a class="btn btn-outline-primary" href="${msg.file_attachment}" download>üìÑ Download ${msg.file_name}</a></div>`;
                                    }
                                }

                                const replyInfo = msg.parent_id ? `
                                    <div class="small text-muted mb-2">
                                        Replying to <a href="/profile/${msg.parent_id ? '' : ''}" class="text-primary text-decoration-none">@${msg.parent_username}</a>:
                                        ‚Äú${msg.parent_excerpt || ''}‚Äù
                                    </div>` : '';

                                const actions = IS_AUTH ? `
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary reply-btn" data-message-id="${msg.id}" data-username="${msg.username}">Reply</button>
                                        <button class="btn btn-outline-warning report-btn" data-message-id="${msg.id}" data-username="${msg.username}">Report</button>
                                        ${(msg.is_owner || msg.is_admin) ? `
                                            <button class="btn btn-outline-danger delete-btn" data-message-id="${msg.id}">
                                                ${(msg.is_admin && !msg.is_owner) ? 'Delete (Admin)' : 'Delete'}
                                            </button>` : ``}
                                    </div>` : (msg.is_owner || msg.is_admin) ? `
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-danger delete-btn" data-message-id="${msg.id}">
                                                ${(msg.is_admin && !msg.is_owner) ? 'Delete (Admin)' : 'Delete'}
                                            </button>
                                        </div>` : '';

                                const html = `
                                    <div class="message bg-black border border-secondary rounded p-3 mb-3" id="message-${msg.id}" data-message-id="${msg.id}" data-user-id="${msg.user_id}">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="d-flex align-items-center">
                                                <strong><a href="/profile/${msg.user_id}/" class="text-primary text-decoration-none">${msg.username}</a></strong>
                                                <small class="text-muted ms-2">just now</small>
                                            </div>
                                            ${actions}
                                        </div>
                                        ${replyInfo}
                                        <p class="text-light mb-2 message-body">${msg.body || ''}</p>
                                        ${fileHtml}
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-sm ${msg.user_vote === 'like' ? 'btn-primary' : 'btn-outline-primary'} like-btn" data-message-id="${msg.id}">
                                                üëç <span class="like-count">${msg.like_count}</span>
                                            </button>
                                            <button class="btn btn-sm ${msg.user_vote === 'dislike' ? 'btn-danger' : 'btn-outline-danger'} dislike-btn" data-message-id="${msg.id}">
                                                üëé <span class="dislike-count">${msg.dislike_count}</span>
                                            </button>
                                        </div>
                                    </div>`;
                                $('#chat-messages').append(html);
                            }
                        });
                        lastMessageId = response.last_id;
                        $('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);
                    }

                    if (response.participants) {
                        const $list = $('#participants-list');
                        $list.empty();
                        response.participants.forEach(function (p) {
                            $list.append(`
                                <a href="/profile/${p.id}/" class="list-group-item list-group-item-action bg-dark text-light border-secondary d-flex justify-content-between align-items-center">
                                    ${p.username}
                                    ${p.is_superuser ? '<span class="badge bg-danger">ADMIN</span>' : ''}
                                </a>`);
                        });
                        $('#participant-count').text(response.participants.length);
                        $('#participants-count-display').text(response.participants.length);
                    }
                }
            });
        }, 2000);

        // Send message
        $('#message-form').on('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const text = ($('#chat-message-input').val() || '').trim();
            const hasFile = !!formData.get('file_attachment');

            if (!text && !hasFile) {
                alert('Please enter a message or attach a file');
                return;
            }

            $.ajax({
                url: window.location.href,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    $('#chat-message-input').val('');
                    $('#file_attachment').val('');
                    $('#parent_id').val('');
                    $('#reply-context').addClass('d-none');
                },
                error: function () {
                    alert('Error sending message');
                }
            });
        });

        // Confirm delete
        $('#confirmDeleteBtn').on('click', function () {
            if (!currentMessageId) return;
            const $btn = $(this).prop('disabled', true).text('Deleting...');

            $.ajax({
                url: `/delete-message/${currentMessageId}/`,
                type: 'POST',
                success: function () {
                    $(`#message-${currentMessageId}`).fadeOut(120, function () {
                        $(this).remove();
                    });
                    safeHideModal(deleteModal, deleteModalEl);
                    currentMessageId = null;
                    $btn.prop('disabled', false).text('Delete Message');
                },
                error: function () {
                    alert('Error deleting message');
                    safeHideModal(deleteModal, deleteModalEl);
                    $btn.prop('disabled', false).text('Delete Message');
                }
            });
        });

        // Like/Dislike (delegated)
        $(document).on('click', '.like-btn, .dislike-btn', function () {
            const $btn = $(this);
            const id = $btn.data('message-id');
            const voteType = $btn.hasClass('like-btn') ? 'like' : 'dislike';

            $.ajax({
                url: `/vote/${id}/`,
                type: 'POST',
                data: { vote_type: voteType },
                success: function (res) {
                    const $row = $btn.closest('.message');
                    const $likeBtn = $row.find('.like-btn');
                    const $dislikeBtn = $row.find('.dislike-btn');

                    $row.find('.like-count').text(res.like_count);
                    $row.find('.dislike-count').text(res.dislike_count);

                    $likeBtn.removeClass('btn-primary').addClass('btn-outline-primary');
                    $dislikeBtn.removeClass('btn-danger').addClass('btn-outline-danger');

                    if (res.action !== 'removed') {
                        if (res.vote_type === 'like') {
                            $likeBtn.removeClass('btn-outline-primary').addClass('btn-primary');
                        } else if (res.vote_type === 'dislike') {
                            $dislikeBtn.removeClass('btn-outline-danger').addClass('btn-danger');
                        }
                    }
                },
                error: function (xhr) {
                    if (xhr.status === 401) {
                        alert('Please login to vote!');
                        window.location.href = '/login/';
                    } else {
                        alert('Error voting');
                    }
                }
            });
        });
    });
</script>
</body>
</html>